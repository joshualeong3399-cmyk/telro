import{a as f,j as t}from"./index-B5tky5X5.js";import{r}from"./vendor-DqoTkSux.js";import{N as y,T as W,v as P,S as $,O as A,B as p,a0 as Y,aj as S,ai as Z,av as J,Y as X,Z as ee,K as te,_ as ae,a5 as se,M as ne,a6 as U,Q as o,a as j,U as re,h as O,ag as ie,a8 as le,a1 as oe,a2 as de,a3 as ce}from"./antd-BHLZumV9.js";import"./store-DlF-iav1.js";const h={list:s=>f.get("/audio-files",{params:s}),get:s=>f.get(`/audio-files/${s}`),upload:(s,n)=>{const l=new FormData;return l.append("file",s),l.append("name",n.name),n.category&&l.append("category",n.category),f.post("/audio-files",l,{headers:{"Content-Type":"multipart/form-data"}})},update:(s,n)=>f.put(`/audio-files/${s}`,n),delete:s=>f.delete(`/audio-files/${s}`),getPlayUrl:s=>`/api/audio-files/${s}/play`},{Title:ue,Text:b}=W,{Option:me}=U;function fe(s){const n=Math.floor(s/60),l=s%60;return`${n}:${String(l).padStart(2,"0")}`}function F(s){return s>1024*1024?`${(s/1024/1024).toFixed(1)} MB`:`${Math.round(s/1024)} KB`}const pe=["提示音","等待音乐","IVR 话术","问候语","其他"],he=[{id:1,name:"欢迎语",filename:"welcome.wav",duration:8,size:128e3,format:"wav",category:"问候语",usedIn:["主菜单 IVR"],createdAt:"2025-01-01"},{id:2,name:"等待音乐",filename:"hold_music.mp3",duration:180,size:288e4,format:"mp3",category:"等待音乐",usedIn:["销售队列","客服队列"],createdAt:"2025-01-05"},{id:3,name:"非工作时间提示",filename:"afterhours.wav",duration:12,size:192e3,format:"wav",category:"IVR 话术",usedIn:["非工作时间 IVR"],createdAt:"2025-01-10"},{id:4,name:"按键提示",filename:"dtmf_menu.wav",duration:20,size:32e4,format:"wav",category:"IVR 话术",usedIn:[],createdAt:"2025-01-15"}],Ie=()=>{const[s,n]=r.useState([]),[l,T]=r.useState(!1),[z,C]=r.useState(!1),[V,x]=r.useState(0),[B,I]=r.useState(!1),[M,_]=r.useState(null),[d,c]=r.useState(null),[g,k]=r.useState(""),[w]=y.useForm(),v=r.useRef(null),E=async()=>{T(!0);try{n(await h.list())}catch{n(he)}finally{T(!1)}};r.useEffect(()=>{E()},[]);const D=e=>{var i,u;if(d===e){(i=v.current)==null||i.pause(),c(null);return}(u=v.current)==null||u.pause();const a=new Audio(h.getPlayUrl(e));a.onerror=()=>{o.info("音频播放演示（实际需后端支持）")},a.onended=()=>c(null),v.current=a,a.play().catch(()=>{o.info("音频播放演示模式"),c(e),setTimeout(()=>c(null),3e3)}),c(e)},G={accept:".wav,.mp3,.gsm",showUploadList:!1,beforeUpload:e=>["audio/wav","audio/mpeg","audio/x-wav"].includes(e.type)||e.name.match(/\.(wav|mp3|gsm)$/i)?e.size>20*1024*1024?(o.error("文件不能超过 20MB"),S.LIST_IGNORE):!0:(o.error("只支持 WAV、MP3、GSM 格式"),S.LIST_IGNORE),customRequest:async({file:e,onSuccess:a,onError:i,onProgress:u})=>{C(!0),x(0);const Q=setInterval(()=>x(m=>Math.min(m+20,90)),300);try{const m=await h.upload(e,{name:e.name.replace(/\.[^.]+$/,""),category:"其他"});n(R=>[m,...R]),o.success(`${e.name} 上传成功`),a==null||a({})}catch{const m={id:Date.now(),name:e.name.replace(/\.[^.]+$/,""),filename:e.name,duration:0,size:e.size,format:e.name.split(".").pop()??"wav",usedIn:[],createdAt:new Date().toISOString()};n(R=>[m,...R]),o.success(`${e.name} 上传成功（演示）`),a==null||a({})}finally{clearInterval(Q),x(100),setTimeout(()=>{C(!1),x(0)},500)}}},K=e=>{_(e),w.setFieldsValue(e),I(!0)},L=async()=>{const e=await w.validateFields();try{await h.update(M.id,e)}catch{}n(a=>a.map(i=>i.id===M.id?{...i,...e}:i)),I(!1),o.success("更新成功")},N=s.filter(e=>!g||e.name.includes(g)||e.filename.includes(g)),q=[{title:"名称",dataIndex:"name",width:160,render:(e,a)=>t.jsxs($,{children:[t.jsx(P,{style:{color:d===a.id?"#1677ff":"#bbb"}}),t.jsx(b,{strong:!0,children:e})]})},{title:"文件名",dataIndex:"filename",width:180,render:e=>t.jsx(b,{type:"secondary",style:{fontSize:12},children:e})},{title:"格式",dataIndex:"format",width:70,render:e=>t.jsx(j,{children:e.toUpperCase()})},{title:"时长",dataIndex:"duration",width:80,render:e=>fe(e)},{title:"大小",dataIndex:"size",width:90,render:e=>F(e)},{title:"分类",dataIndex:"category",width:100,render:e=>e?t.jsx(j,{color:"blue",children:e}):"-"},{title:"使用情况",dataIndex:"usedIn",width:180,render:e=>e.length>0?e.map(a=>t.jsx(j,{color:"cyan",children:a},a)):t.jsx(j,{color:"default",children:"未使用"})},{title:"上传时间",dataIndex:"createdAt",width:120,render:e=>re(e).format("MM-DD HH:mm")},{title:"操作",key:"op",width:140,fixed:"right",render:(e,a)=>t.jsxs($,{children:[t.jsx(O,{title:d===a.id?"停止":"播放",children:t.jsx(p,{size:"small",type:d===a.id?"primary":"default",icon:d===a.id?t.jsx(ie,{}):t.jsx(le,{}),onClick:()=>D(a.id)})}),t.jsx(O,{title:"重命名",children:t.jsx(p,{size:"small",icon:t.jsx(oe,{}),onClick:()=>K(a)})}),t.jsx(de,{title:a.usedIn.length>0?`该文件被 ${a.usedIn.length} 处使用，确认删除？`:"确认删除？",onConfirm:async()=>{try{await h.delete(a.id)}catch{}n(i=>i.filter(u=>u.id!==a.id))},children:t.jsx(p,{size:"small",danger:!0,icon:t.jsx(ce,{})})})]})}],H=s.reduce((e,a)=>e+a.size,0);return t.jsxs("div",{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsxs(ue,{level:4,style:{margin:0},children:[t.jsx(P,{})," 音频文件管理"]}),t.jsxs($,{children:[t.jsx(A.Search,{placeholder:"搜索文件名",value:g,onChange:e=>k(e.target.value),style:{width:200},allowClear:!0}),t.jsx(p,{icon:t.jsx(Y,{}),onClick:E,children:"刷新"}),t.jsx(S,{...G,children:t.jsx(p,{type:"primary",icon:t.jsx(Z,{}),loading:z,children:"上传音频"})})]})]}),z&&t.jsx(J,{percent:V,style:{marginBottom:12}}),t.jsx(X,{gutter:[12,12],style:{marginBottom:16},children:[{title:"文件总数",value:s.length,color:"#1677ff",suffix:"个"},{title:"总占用空间",value:F(H),color:"#722ed1",suffix:""},{title:"在用文件",value:s.filter(e=>e.usedIn.length>0).length,color:"#52c41a",suffix:"个"}].map(e=>t.jsx(ee,{xs:12,sm:8,children:t.jsx(te,{size:"small",style:{borderTop:`3px solid ${e.color}`,borderRadius:8},children:t.jsx(ae,{title:e.title,value:e.value,suffix:e.suffix,valueStyle:{color:e.color}})})},e.title))}),t.jsx(se,{columns:q,dataSource:N,rowKey:"id",loading:l,scroll:{x:1e3}}),t.jsx(ne,{title:"编辑音频文件",open:B,onOk:L,onCancel:()=>I(!1),okText:"保存",cancelText:"取消",children:t.jsxs(y,{form:w,layout:"vertical",style:{marginTop:16},children:[t.jsx(y.Item,{name:"name",label:"文件名称",rules:[{required:!0}],children:t.jsx(A,{})}),t.jsx(y.Item,{name:"category",label:"分类",children:t.jsx(U,{allowClear:!0,placeholder:"选择分类",children:pe.map(e=>t.jsx(me,{value:e,children:e},e))})})]})})]})};export{Ie as default};
