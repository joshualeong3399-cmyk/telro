import{a as d,j as e}from"./index-B5tky5X5.js";import{r as i}from"./vendor-DqoTkSux.js";import{N as o,T as K,S as f,B as c,a0 as q,a4 as P,X as V,a5 as Q,M as $,aa as W,D as p,K as X,a as j,R as F,O as v,ad as A,h as R,C as G,am as H,a1 as J,a2 as U,a3 as Y,Q as g}from"./antd-BHLZumV9.js";import"./store-DlF-iav1.js";const y={list:()=>d.get("/ivr"),get:n=>d.get(`/ivr/${n}`),create:n=>d.post("/ivr",n),update:(n,a)=>d.put(`/ivr/${n}`,a),delete:n=>d.delete(`/ivr/${n}`),syncAsterisk:n=>d.post(`/ivr/${n}/sync`)},{Title:Z,Text:b}=K,k={greeting:"blue",menu:"purple",playback:"cyan",transfer:"green",hangup:"red",condition:"orange"},D={greeting:"欢迎语",menu:"DTMF 菜单",playback:"播放语音",transfer:"转接",hangup:"挂断",condition:"条件判断"},ee=[{id:1,name:"主菜单 IVR",extension:"9000",entryNode:"n1",enabled:!0,createdAt:"2025-01-01",description:"主叫进入后的 IVR 主菜单",nodes:[{id:"n1",type:"greeting",label:"欢迎语",audioFile:"welcome.wav",timeout:5},{id:"n2",type:"menu",label:"主菜单",dtmfOptions:{1:"n3",2:"n4",0:"n5"},timeout:10,retries:3},{id:"n3",type:"transfer",label:"转销售",transferTarget:"销售队列"},{id:"n4",type:"transfer",label:"转客服",transferTarget:"客服队列"},{id:"n5",type:"hangup",label:"挂断"}]},{id:2,name:"非工作时间 IVR",extension:"9001",entryNode:"n1",enabled:!0,createdAt:"2025-01-10",nodes:[{id:"n1",type:"playback",label:"非工作时间提示",audioFile:"afterhours.wav"},{id:"n2",type:"hangup",label:"挂断"}]}],te=({nodes:n})=>e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:8},children:n.map(a=>e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:4},children:[e.jsxs(j,{color:k[a.type],children:[D[a.type],": ",a.label]}),a.dtmfOptions&&e.jsxs(b,{type:"secondary",style:{fontSize:11},children:["[",Object.keys(a.dtmfOptions).map(I=>`按${I}`).join("/"),"]"]})]},a.id))}),ie=()=>{const[n,a]=i.useState([]),[I,S]=i.useState(!1),[N,x]=i.useState(!1),[l,T]=i.useState(null),[m,O]=i.useState(null),[h]=o.useForm(),[z,C]=i.useState(null),w=async()=>{S(!0);try{a(await y.list())}catch{a(ee)}finally{S(!1)}};i.useEffect(()=>{w()},[]);const E=()=>{O(null),h.resetFields(),h.setFieldsValue({enabled:!0}),x(!0)},M=t=>{O(t),h.setFieldsValue(t),x(!0)},B=async()=>{const t=await h.validateFields();try{m?(await y.update(m.id,t),g.success("更新成功")):(await y.create(t),g.success("创建成功")),x(!1),w()}catch{const s={...t,id:Date.now(),entryNode:"",nodes:[],enabled:t.enabled??!0,createdAt:new Date().toISOString()};a(r=>m?r.map(u=>u.id===m.id?{...u,...t}:u):[...r,s]),x(!1)}},L=async t=>{C(t);try{await y.syncAsterisk(t),g.success("同步成功")}catch{g.success("同步成功（演示）")}finally{C(null)}},_=[{title:"名称",dataIndex:"name",width:180},{title:"分机号",dataIndex:"extension",width:90,render:t=>e.jsx(j,{icon:e.jsx(F,{}),color:"blue",children:t})},{title:"IVR 流程",key:"nodes",width:320,render:(t,s)=>s.nodes.length>0?e.jsx(te,{nodes:s.nodes.slice(0,4)}):e.jsx(b,{type:"secondary",children:"暂无节点"})},{title:"说明",dataIndex:"description",width:160,ellipsis:!0},{title:"启用",dataIndex:"enabled",width:70,render:t=>e.jsx(A,{checked:t,size:"small",disabled:!0})},{title:"操作",key:"actions",width:180,fixed:"right",render:(t,s)=>e.jsxs(f,{children:[e.jsx(R,{title:"查看详情",children:e.jsx(c,{size:"small",icon:e.jsx(G,{}),onClick:()=>T(s)})}),e.jsx(R,{title:"同步 Asterisk",children:e.jsx(c,{size:"small",icon:e.jsx(H,{}),loading:z===s.id,onClick:()=>L(s.id)})}),e.jsx(R,{title:"编辑",children:e.jsx(c,{size:"small",icon:e.jsx(J,{}),onClick:()=>M(s)})}),e.jsx(U,{title:"确认删除？",onConfirm:async()=>{try{await y.delete(s.id)}catch{}a(r=>r.filter(u=>u.id!==s.id))},children:e.jsx(c,{size:"small",danger:!0,icon:e.jsx(Y,{})})})]})}];return e.jsxs("div",{children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[e.jsx(Z,{level:4,style:{margin:0},children:"IVR 管理"}),e.jsxs(f,{children:[e.jsx(c,{icon:e.jsx(q,{}),onClick:w,children:"刷新"}),e.jsx(c,{type:"primary",icon:e.jsx(P,{}),onClick:E,children:"新建 IVR"})]})]}),e.jsx(V,{message:"IVR 节点可视化编辑器正在开发中，当前支持基础配置管理及同步功能。",type:"info",showIcon:!0,style:{marginBottom:16}}),e.jsx(Q,{columns:_,dataSource:n,rowKey:"id",loading:I,scroll:{x:900}}),e.jsx($,{title:`IVR 详情 — ${l==null?void 0:l.name}`,open:!!l,footer:null,onCancel:()=>T(null),width:640,children:l&&e.jsx(W,{items:[{key:"info",label:"基本信息",children:e.jsxs(p,{column:2,bordered:!0,size:"small",children:[e.jsx(p.Item,{label:"名称",children:l.name}),e.jsx(p.Item,{label:"分机号",children:l.extension}),e.jsx(p.Item,{label:"入口节点",children:l.entryNode}),e.jsx(p.Item,{label:"启用",children:l.enabled?"是":"否"}),e.jsx(p.Item,{label:"说明",span:2,children:l.description??"-"})]})},{key:"nodes",label:`节点 (${l.nodes.length})`,children:e.jsx(f,{direction:"vertical",style:{width:"100%"},children:l.nodes.map(t=>e.jsxs(X,{size:"small",style:{borderLeft:`3px solid ${k[t.type]==="red"?"#ff4d4f":"#1677ff"}`},children:[e.jsxs(f,{children:[e.jsx(j,{color:k[t.type],children:D[t.type]}),e.jsx(b,{strong:!0,children:t.label}),t.audioFile&&e.jsx(j,{icon:e.jsx(F,{}),children:t.audioFile}),t.transferTarget&&e.jsxs(b,{type:"secondary",children:["→ ",t.transferTarget]})]}),t.dtmfOptions&&e.jsx("div",{style:{marginTop:8},children:Object.entries(t.dtmfOptions).map(([s,r])=>e.jsxs(j,{style:{margin:2},children:["按 ",s," → ",r]},s))})]},t.id))})}]})}),e.jsxs($,{title:m?"编辑 IVR":"新建 IVR",open:N,onOk:B,onCancel:()=>x(!1),width:480,okText:"保存",cancelText:"取消",children:[e.jsxs(o,{form:h,layout:"vertical",style:{marginTop:16},children:[e.jsx(o.Item,{name:"name",label:"IVR 名称",rules:[{required:!0}],children:e.jsx(v,{})}),e.jsx(o.Item,{name:"extension",label:"分机号",rules:[{required:!0}],children:e.jsx(v,{placeholder:"例如：9000"})}),e.jsx(o.Item,{name:"description",label:"说明",children:e.jsx(v.TextArea,{rows:2})}),e.jsx(o.Item,{name:"enabled",label:"启用",valuePropName:"checked",children:e.jsx(A,{})})]}),e.jsx(V,{message:"节点配置请通过可视化编辑器操作（开发中）",type:"info",showIcon:!0})]})]})};export{ie as default};
