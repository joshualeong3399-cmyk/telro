import{a as f,j as t}from"./index-B5tky5X5.js";import{r as d}from"./vendor-DqoTkSux.js";import{T as K,q as P,S as I,a6 as A,B as m,a0 as X,a2 as B,Y as L,Z as U,K as T,_ as W,a8 as $,ar as _,ab as H,a5 as q,Q,i as C,a as k,p as V,U as Y,h as N,ag as Z,as as G,a3 as J}from"./antd-BHLZumV9.js";import"./store-DlF-iav1.js";const h={list:i=>f.get("/voicemail",{params:i}),get:i=>f.get(`/voicemail/${i}`),markListened:i=>f.patch(`/voicemail/${i}`,{listened:!0}),delete:i=>f.delete(`/voicemail/${i}`),deleteBatch:i=>f.post("/voicemail/batch-delete",{ids:i}),getAudioUrl:i=>`/api/voicemail/${i}/audio`},{Title:ee,Text:x}=K,{Option:te}=A;function w(i){const n=Math.floor(i/60),j=i%60;return`${n}:${String(j).padStart(2,"0")}`}const ie=[{id:1,mailbox:"8001",callerId:"张三",callerIdNumber:"13812345678",duration:42,folder:"INBOX",listened:!1,filename:"msg0001.wav",createdAt:"2025-02-19 09:15:00"},{id:2,mailbox:"8001",callerId:"李四",callerIdNumber:"13987654321",duration:78,folder:"INBOX",listened:!0,filename:"msg0002.wav",createdAt:"2025-02-18 16:30:00",transcription:"您好，我想咨询一下产品价格，请回电..."},{id:3,mailbox:"8002",callerId:"未知",callerIdNumber:"02155551234",duration:15,folder:"Old",listened:!0,filename:"msg0003.wav",createdAt:"2025-02-17 14:00:00"},{id:4,mailbox:"8003",callerId:"客户A",callerIdNumber:"13600001111",duration:120,folder:"INBOX",listened:!1,filename:"msg0004.wav",createdAt:"2025-02-19 10:00:00",transcription:"我是客户A，关于上次签约的事情需要确认一些细节..."}],ne=()=>{const[i,n]=d.useState([]),[j,v]=d.useState(!1),[g,O]=d.useState("INBOX"),[o,b]=d.useState([]),[l,y]=d.useState(null),S=d.useRef(null),c=d.useRef(null),R=async()=>{v(!0);try{const e=await h.list({folder:g});n(e.data)}catch{n(ie.filter(e=>e.folder===g))}finally{v(!1)}};d.useEffect(()=>{R()},[g]);const p=()=>{var e;(e=S.current)==null||e.pause(),c.current&&(clearInterval(c.current),c.current=null),y(null)},z=async e=>{if((l==null?void 0:l.voicemailId)===e.id){p();return}p();try{await h.markListened(e.id)}catch{}n(r=>r.map(u=>u.id===e.id?{...u,listened:!0}:u));const a=h.getAudioUrl(e.id),s=new Audio(a);s.onerror=()=>{y({voicemailId:e.id,playing:!0,progress:0,duration:e.duration,currentTime:0}),c.current=setInterval(()=>{y(r=>{if(!r||r.currentTime>=r.duration)return c.current&&clearInterval(c.current),null;const u=r.currentTime+1;return{...r,currentTime:u,progress:Math.round(u/r.duration*100)}})},1e3)},S.current=s,s.play().catch(()=>{var r;return(r=s.onerror)==null?void 0:r.call(s,new Event("error"))}),y({voicemailId:e.id,playing:!0,progress:0,duration:e.duration,currentTime:0})},F=async e=>{try{await h.delete(e)}catch{}n(a=>a.filter(s=>s.id!==e))},D=async()=>{try{await h.deleteBatch(o)}catch{}n(e=>e.filter(a=>!o.includes(a.id))),b([]),Q.success("已删除所选留言")},M=[{title:"状态",dataIndex:"listened",width:70,align:"center",render:e=>e?t.jsx(C,{status:"default"}):t.jsx(C,{status:"processing",text:""})},{title:"信箱",dataIndex:"mailbox",width:80,render:e=>t.jsx(k,{children:e})},{title:"来电显示",key:"caller",width:170,render:(e,a)=>t.jsxs(t.Fragment,{children:[t.jsx(x,{children:a.callerId}),t.jsx("br",{}),t.jsx(x,{type:"secondary",style:{fontSize:12},children:a.callerIdNumber})]})},{title:"时长",dataIndex:"duration",width:80,render:e=>t.jsx(k,{icon:t.jsx(V,{}),children:w(e)})},{title:"转写内容",dataIndex:"transcription",width:260,ellipsis:!0,render:e=>e?t.jsx(x,{type:"secondary",italic:!0,children:e}):t.jsx(x,{type:"secondary",children:"—"})},{title:"时间",dataIndex:"createdAt",width:150,render:e=>Y(e).format("MM-DD HH:mm")},{title:"操作",key:"op",width:120,fixed:"right",render:(e,a)=>t.jsxs(I,{children:[t.jsx(N,{title:(l==null?void 0:l.voicemailId)===a.id?"停止":"播放",children:t.jsx(m,{size:"small",type:(l==null?void 0:l.voicemailId)===a.id?"primary":"default",icon:(l==null?void 0:l.voicemailId)===a.id?t.jsx(Z,{}):t.jsx($,{}),onClick:()=>z(a)})}),!a.listened&&t.jsx(N,{title:"标记已读",children:t.jsx(m,{size:"small",icon:t.jsx(G,{}),onClick:async()=>{try{await h.markListened(a.id)}catch{}n(s=>s.map(r=>r.id===a.id?{...r,listened:!0}:r))}})}),t.jsx(B,{title:"确认删除此留言？",onConfirm:()=>F(a.id),children:t.jsx(m,{size:"small",danger:!0,icon:t.jsx(J,{})})})]})}],E=i.filter(e=>!e.listened).length;return t.jsxs("div",{children:[t.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16},children:[t.jsxs(ee,{level:4,style:{margin:0},children:[t.jsx(P,{})," 语音信箱"]}),t.jsxs(I,{children:[t.jsx(A,{value:g,onChange:O,style:{width:120},children:["INBOX","Old","Work","Family","Friends"].map(e=>t.jsx(te,{value:e,children:e},e))}),t.jsx(m,{icon:t.jsx(X,{}),onClick:R,children:"刷新"}),o.length>0&&t.jsx(B,{title:`确认删除 ${o.length} 条留言？`,onConfirm:D,children:t.jsxs(m,{danger:!0,children:["批量删除 (",o.length,")"]})})]})]}),t.jsx(L,{gutter:[12,12],style:{marginBottom:16},children:[{title:"总留言数",value:i.length,color:"#1677ff"},{title:"未读",value:E,color:"#fa541c"}].map(e=>t.jsx(U,{xs:12,sm:6,children:t.jsx(T,{size:"small",style:{borderTop:`3px solid ${e.color}`,borderRadius:8},children:t.jsx(W,{title:e.title,value:e.value,valueStyle:{color:e.color}})})},e.title))}),l&&t.jsx(T,{size:"small",style:{marginBottom:16,background:"#e6f4ff",border:"1px solid #91caff"},children:t.jsxs(I,{style:{width:"100%"},align:"center",children:[t.jsx($,{style:{color:"#1677ff",fontSize:20}}),t.jsxs(x,{strong:!0,style:{minWidth:80},children:[w(l.currentTime)," / ",w(l.duration)]}),t.jsx(_,{value:l.progress,style:{flex:1,minWidth:200},tooltip:{formatter:null}}),t.jsx(m,{size:"small",onClick:p,children:"停止"})]})}),i.length===0&&!j?t.jsx(H,{description:"当前文件夹无留言"}):t.jsx(q,{columns:M,dataSource:i,rowKey:"id",loading:j,scroll:{x:860},rowSelection:{selectedRowKeys:o,onChange:e=>b(e)},rowClassName:e=>e.listened?"":"voicemail-unread"}),t.jsx("style",{children:".voicemail-unread td { font-weight: 600; }"})]})};export{ne as default};
